<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOTA-LINK Status</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>KOTA-LINK DIAGRAM</h1>
    <div class="diagram">
        <div class="row" id="row1">
            <div id="allstar" class="box">Allstar 57686<span class="status"></span></div>
        </div>
        <div class="row" id="row2">
            <div id="echolink1" class="box">Echolink: N0DYG-R 910094<span class="status"></span></div>
            <div id="echolink2" class="box">Echolink: HOIP#15031<span class="status"></span></div>
            <div id="echolink3" class="box">Echolink: HHUS#94177<span class="status"></span></div>
        </div>
        <div class="row" id="row3">
            <div id="analog" class="box">Analog Reflector<span class="status"></span></div>
        </div>
        <div class="row" id="row4">
            <div id="ab_mb" class="box">AB + MB<span class="status"></span></div>
            <div id="mb" class="box">MB<span class="status"></span></div>
            <div id="usrp2p25" class="box">USRP2P25<span class="status"></span></div>
        </div>
        <div class="row" id="row5">
            <div id="dmr" class="box green">DMR TGIF: 350<span class="status"></span></div>
            <div id="ysf" class="box green">YSF: US-KOTA-LINK 57686<span class="status"></span></div>
            <div id="p25" class="box green">P25: 65103<span class="status"></span></div>
        </div>
        <div class="row" id="row6">
            <div class="box gray">We plan to add these later on: M17, NXDN, DSTAR</div>
        </div>
        <svg id="svg"></svg>
    </div>
    <script>
        async function fetchStatus() {
            const response = await fetch('/api/status');
            const status = await response.json();

            updateStatus('allstar', status.allstar);
            updateStatus('echolink1', status.echolink1);
            updateStatus('echolink2', status.echolink2);
            updateStatus('echolink3', status.echolink3);
            updateStatus('analog', status.analog);
            updateStatus('ab_mb', status.ab_mb);
            updateStatus('mb', status.mb);
            updateStatus('usrp2p25', status.usrp2p25);
            updateStatus('dmr', status.dmr);
            updateStatus('ysf', status.ysf);
            updateStatus('p25', status.p25);
        }

        function updateStatus(id, status) {
            const element = document.getElementById(id);
            element.querySelector('.status').textContent = ` (${status})`;
            element.classList.remove('green', 'yellow', 'red');
            if (status === 'online') {
                element.classList.add('green');
            } else if (status === 'unlinked') {
                element.classList.add('yellow');
            } else {
                element.classList.add('red');
            }
        }

        function drawLines() {
            const svg = document.getElementById('svg');
            svg.innerHTML = '';

            drawLine(svg, 'allstar', 'analog');
            drawLine(svg, 'allstar', 'echolink1');
            drawLine(svg, 'allstar', 'echolink2');
            drawLine(svg, 'allstar', 'echolink3');
        }

        function drawLine(svg, id1, id2) {
            const box1 = document.getElementById(id1).getBoundingClientRect();
            const box2 = document.getElementById(id2).getBoundingClientRect();

            const x1 = box1.left + box1.width / 2;
            const y1 = box1.top + box1.height / 2;
            const x2 = box2.left + box2.width / 2;
            const y2 = box2.top + box2.height / 2;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.classList.add('line');

            if (document.getElementById(id1).classList.contains('green') && document.getElementById(id2).classList.contains('green')) {
                line.classList.add('green');
            } else if (document.getElementById(id1).classList.contains('yellow') || document.getElementById(id2).classList.contains('yellow')) {
                line.classList.add('yellow');
            } else {
                line.classList.add('red');
            }

            svg.appendChild(line);
        }

        window.addEventListener('resize', drawLines);
        fetchStatus().then(drawLines);
        setInterval(fetchStatus, 10000);
    </script>
</body>
</html>
